# Heru IoT Server

The Heru IoT Server is the central nervous system for ingesting, processing, and securing data from our cold chain monitoring devices. It is designed to be robust, scalable, and secure, ensuring that every piece of sensor data is reliably handled and recorded on a tamper-proof ledger.

## Architecture

The server is composed of several microservices that work in concert to handle the data flow from IoT devices to external services like databases and blockchain ledgers.

```mermaid
graph TD
    subgraph IoT Devices
        A[ESP32 Sensor 1]
        B[ESP32 Sensor 2]
        C[...]
    end

    subgraph IoT Server
        D[MQTT Broker]
        E[IoT Ingestion Service]
        F[Background Job Queue e.g. Redis]
        G[Background Worker]
    end

    subgraph External Services
        H[PostgreSQL Database]
        I[IPFS Pinata]
        J[Hedera Services HCS Guardian]
        K[Notification Hub PWA Push SMS]
    end

    A -- MQTT over TLS --> D
    B -- MQTT over TLS --> D
    C -- MQTT over TLS --> D

    D -- Pub/Sub --> E
    E -- Stores Raw Data --> H
    E -- Triggers Immediate Alerts --> K
    E -- Pushes Job --> F
    F -- Distributes Job --> G

    G -- Uploads Metadata --> I
    G -- Logs Hashes & Checks Rules --> J
    G -- Updates DB with CIDs/Hashes --> H
```

## Core Components

### 1. MQTT Broker
- **Purpose**: The primary entry point for all data from IoT sensors.
- **Technology**: A secure MQTT broker that accepts connections over TLS.
- **Flow**: Receives data from numerous ESP32 sensors and publishes it to specific topics for consumption by the ingestion service.

### 2. IoT Ingestion Service
- **Purpose**: To consume, validate, and route incoming sensor data.
- **Flow**:
    - Subscribes to the MQTT Broker to receive real-time sensor readings.
    - Immediately stores the raw, unprocessed data into the **PostgreSQL Database** for auditing and historical tracking.
    - Analyzes data against predefined rules. If a rule is breached (e.g., temperature out of range), it triggers an immediate alert via the **Notification Hub**.
    - Pushes a job containing the data to the **Background Job Queue** for more intensive, asynchronous processing.

### 3. Background Job Queue
- **Purpose**: To decouple the real-time ingestion service from slower, more complex processing tasks.
- **Technology**: A robust queueing system like Redis.
- **Flow**: Receives jobs from the ingestion service and distributes them to available background workers, ensuring reliable, at-least-once processing.

### 4. Background Worker
- **Purpose**: To perform heavy-lifting tasks that involve external services, ensuring data is permanently and transparently recorded.
- **Flow**:
    - Picks up a job from the queue.
    - Uploads the sensor data and its associated metadata to **IPFS** via the Pinata service, generating a unique Content ID (CID).
    - Logs the data hash and the IPFS CID to **Hedera Services** using the Guardian policy engine. This creates an immutable, verifiable audit trail.
    - Updates the record in the **PostgreSQL Database** with the corresponding IPFS CID and Hedera transaction hash, linking the raw data to its decentralized proof.

## External Services

The IoT Server relies on the following external services:

- **PostgreSQL Database**: The primary datastore for raw sensor data and the metadata (CIDs, hashes) generated by the background worker.
- **IPFS (via Pinata)**: A decentralized storage network used to store sensor data in a tamper-proof manner.
- **Hedera Services (HCS & Guardian)**: A distributed ledger used to create an immutable audit trail of data hashes and enforce compliance rules.
- **Notification Hub**: A service responsible for dispatching real-time alerts via Push Notifications, SMS, or other channels.

## Getting Started

### Prerequisites
- Python 3.9+
- Docker & Docker Compose
- An active PostgreSQL instance
- An active Redis instance
- API credentials for Pinata, Hedera, and the Notification Hub.

### Installation
1.  **Clone the repository**:
    ```bash
    git clone https://github.com/your-username/heru.git
    cd heru/iot-server
    ```
2.  **Set up environment variables**:
    Create a `.env` file and populate it with the necessary credentials for the database and external services.
    ```env
    DATABASE_URL="postgresql://user:password@host:port/database"
    REDIS_URL="redis://host:port"
    PINATA_API_KEY="your_key"
    PINATA_API_SECRET="your_secret"
    HEDERA_ACCOUNT_ID="0.0.XXXX"
    HEDERA_PRIVATE_KEY="your_key"
    # ... other variables
    ```
3.  **Install dependencies**:
    ```bash
    pip install -r requirements.txt
    ```
4.  **Run the server**:
    ```bash
    python main.py
    ```
